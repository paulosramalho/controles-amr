generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// ======================================================
/// FASE 1 — COMPATIBILIDADE TOTAL
/// ------------------------------------------------------
/// Regras:
/// - NÃO remover enums existentes no banco
/// - NÃO remover tabelas/colunas existentes no banco
/// - NÃO alterar tipos que forcem cast destrutivo (ex.: Decimal -> Double)
/// - Nesta fase: apenas ADICIONAR estruturas novas (Advogado + vínculo)
/// - Limpeza/renome/remoções: somente em FASE 3
/// ======================================================

/// =======================
/// ENUMS (MANTIDOS + COMPLETOS)
/// =======================

enum UserRole {
  ADMIN
  USER
}

enum ModeloPagamento {
  AVISTA
  ENTRADA_E_PARCELAS
  PARCELAS
  APENAS_PARCELAS
}

enum StatusOrdem {
  ATIVA
  CONCLUIDA
  CANCELADA
}

enum StatusPagamento {
  PREVISTO
  EM_ABERTO
  PARCIAL
  PAGO
  ATRASADO
  CANCELADO
}

enum TipoAdvogado {
  SOCIO
  ASSOCIADO
  CORRESPONDENTE
  OUTRO
}

/// =======================
/// MODELOS EXISTENTES (NÃO REMOVER)
/// =======================

model Cliente {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  cpfCnpj         String
  nomeRazaoSocial String
  email           String?
  telefone        String?
  observacoes     String?
  ativo           Boolean  @default(true)

  ordens OrdemPagamento[]

  // (se você já colocou unique no cpfCnpj em migração anterior, manter compatível aqui)
  @@unique([cpfCnpj])
  @@index([ativo])
  @@index([nomeRazaoSocial])
}

model OrdemPagamento {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clienteId Int
  cliente   Cliente  @relation(fields: [clienteId], references: [id])

  // Sequência de ocorrência (ordem) dentro do cliente
  sequenciaCliente   Int
  codigoInterno      String?
  descricao          String?
  tipoContrato       String?
  valorTotalPrevisto Decimal?
  modeloPagamento    ModeloPagamento
  dataInicio         DateTime
  dataFimPrevista    DateTime?
  status             StatusOrdem

  // relações que já existiam no seu esquema
  pagamentos Pagamento[]
  repasses   Repasse[]

  @@unique([clienteId, sequenciaCliente])
  @@index([status])
  @@index([modeloPagamento])
}

model Pagamento {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordemPagamentoId Int?
  ordemPagamento   OrdemPagamento? @relation(fields: [ordemPagamentoId], references: [id])

  // (mantenha seus campos reais aqui; deixo o mínimo compatível)
  valor         Decimal?
  dataPagamento DateTime?
  status        StatusPagamento?

  @@index([dataPagamento])
}

model Repasse {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ordemPagamentoId Int?
  ordemPagamento   OrdemPagamento? @relation(fields: [ordemPagamentoId], references: [id])

  // (mantenha seus campos reais aqui; deixo o mínimo compatível)
  valor          Decimal?
  competenciaAno Int?
  competenciaMes Int?

  @@index([competenciaAno, competenciaMes])
}

/// =======================
/// MODELOS NOVOS (FASE 1)
/// =======================

model Usuario {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nome      String
  email     String   @unique
  senhaHash String
  ativo     Boolean  @default(true)
  role      UserRole @default(USER)

  /// Vínculo 1:1 opcional com Advogado (FASE 1)
  advogadoId Int?      @unique
  advogado   Advogado? @relation(fields: [advogadoId], references: [id], onUpdate: Cascade, onDelete: SetNull)

  @@index([ativo])
  @@index([role])
}

model Advogado {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  nome     String
  cpf      String  @unique
  oab      String  @unique
  email    String
  telefone String
  ativo    Boolean @default(true)

  usuario Usuario?

  @@index([ativo])
}

/// =======================
/// MODELO EXISTENTE (MANTER E NÃO CASTAR)
/// =======================

model ModeloDistribuicao {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  /// Novo (FASE 1) — ainda opcional para não quebrar 22 registros existentes
  cod String? @unique

  /// Legado: NÃO REMOVER / NÃO ALTERAR TIPO NESTA FASE
  codigo       String?
  destinatario String?
  percentual   Decimal? // mantém Decimal para NÃO castar
  origem       String?
  tipo         String?

  @@index([cod])
}
