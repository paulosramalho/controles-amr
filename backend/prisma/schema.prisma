generator client 
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id         Int      @id @default(autoincrement())
  nome       String
  email      String   @unique
  senha_hash String
  role       String   @default("user")
  ativo      Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // relations
  solicitacoesCriadas SolicitacaoUsuario[] @relation("SolicitacaoCriadaPor")
  retificacoesParcela RetificacaoParcela[]
  historicosContrato  HistoricoContrato[]
  parcelasCanceladas  ParcelaContrato[]    @relation("ParcelaCanceladaPor")
}

model Cliente {
  id              Int      @id @default(autoincrement())
  nomeRazaoSocial String
  cpfCnpj         String   @unique
  ativo           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contratos ContratoPagamento[]
}

model ContratoPagamento {
  id             Int     @id @default(autoincrement())
  numeroContrato String  @unique
  clienteId      Int
  cliente        Cliente @relation(fields: [clienteId], references: [id])

  formaPagamento String
  valorTotal     Decimal @db.Decimal(14, 2)
  observacoes    String?
  ativo          Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ===== Renegociação (pai/filho) =====
  contratoOrigemId Int?
  contratoOrigem   ContratoPagamento? @relation("ContratoOrigem", fields: [contratoOrigemId], references: [id])

  renegociadoParaId Int?
  renegociadoPara   ContratoPagamento? @relation("RenegociadoPara", fields: [renegociadoParaId], references: [id])

  // filhos do contrato (R1, R2...)
  derivados ContratoPagamento[] @relation("ContratoOrigem")

  // contratos que apontam para este como "renegociadoPara"
  renegociadosDele ContratoPagamento[] @relation("RenegociadoPara")

  parcelas  ParcelaContrato[]
  historico HistoricoContrato[]
}

model ParcelaContrato {
  id         Int               @id @default(autoincrement())
  contratoId Int
  contrato   ContratoPagamento @relation(fields: [contratoId], references: [id])

  numero        Int
  vencimento    DateTime
  valorPrevisto Decimal  @db.Decimal(14, 2)
  status        String   @default("PREVISTA")

  valorRecebido   Decimal?  @db.Decimal(14, 2)
  dataRecebimento DateTime?
  meioRecebimento String?

  canceladaEm        DateTime?
  canceladaPorId     Int?
  canceladaPor       Usuario?  @relation("ParcelaCanceladaPor", fields: [canceladaPorId], references: [id])
  cancelamentoMotivo String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  retificacoes RetificacaoParcela[]
}

model RetificacaoParcela {
  id        Int             @id @default(autoincrement())
  parcelaId Int
  parcela   ParcelaContrato @relation(fields: [parcelaId], references: [id])

  motivo         String
  alteracoes     Json
  snapshotAntes  Json
  snapshotDepois Json

  criadoPorId Int?
  criadoPor   Usuario? @relation(fields: [criadoPorId], references: [id])

  createdAt DateTime @default(now())
}

model HistoricoContrato {
  id         Int               @id @default(autoincrement())
  contratoId Int
  contrato   ContratoPagamento @relation(fields: [contratoId], references: [id])

  tipo      String
  descricao String

  criadoPorId Int?
  criadoPor   Usuario? @relation(fields: [criadoPorId], references: [id])

  createdAt DateTime @default(now())
}

model SolicitacaoUsuario {
  id           Int    @id @default(autoincrement())
  nomeCompleto String
  email        String
  telefone     String
  cpf          String
  status       String @default("PENDENTE")

  criadoPorId Int?
  criadoPor   Usuario? @relation("SolicitacaoCriadaPor", fields: [criadoPorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
